<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" type="text/css" href="./assets/styles/style.css">
  <title>Twitter Profile</title>
</head>
<body>
<header id="main-header">
  <div class="content">
    <nav>
      <ul>
        <li>
          <img src="./assets/images/home.svg" alt="Home" /> Home
        </li>
        <li>
          <img src="./assets/images/notification.svg" alt="Notifications" /> Notifications
        </li>
        <li>
          <img src="./assets/images/message.svg" alt="Messages" /> Messages
        </li>
      </ul>
    </nav>
    <img src="./assets/images/logo.svg" alt="Logo Twitter" />
    <div class="side">
      <label>
        <input type="text" placeholder="Search on Twitter" />
      </label>
      <img src="./assets/images/avatar.png" alt="Avatar" />
      <button>Tweet</button>
    </div>
  </div>
</header>

<div class="banner">
  <h1>Twitter</h1>
</div>

<div class="bar">
  <div class="content">
    <ul>
      <li class="active">
        <span>Tweet</span>
        <strong>1234</strong>
      </li>
      <li>
        <span>Followings</span>
        <strong>124</strong>
      </li>
      <li>
        <span>Followers</span>
        <strong>134</strong>
      </li>
      <li>
        <span>Favorites</span>
        <strong>14</strong>
      </li>
    </ul>
    <div class="actions">
      <button>Follow</button>
      <img src="./assets/images/more.svg" alt="More" />
    </div>
  </div>
</div>

<div class="wrapper-content content">
  <aside class="profile">
    <img class="avatar" src="./assets/images/avatar.png" alt="Beatriz Cantilho" />
    <h1>Beatriz Cantilho</h1>
    <span>@bcantilho</span>
    <p>Software developer and sometimes gamer</p>

    <ul class="list">
      <li><img src="./assets/images/place.svg" alt="place" /> Halifax, Canad√°</li>
      <li><img src="./assets/images/url.svg" alt="url" /> bcantilho.dev</li>
      <li><img src="./assets/images/joined.svg" alt="joined" /> Joined January 2017</li>
      <li><img src="./assets/images/born.svg" alt="born" /> Born the 10th of January 1996</li>
    </ul>

    <div class="widget followers">
      <strong>
        <img src="./assets/images/followers.svg" alt="followers" /> 120 followers that you know
      </strong>
      <ul>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </div>

    <div class="widget images">
      <strong>
        <img src="./assets/images/images.svg" alt="images" /> 360 Photos and videos
      </strong>
      <ul>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </div>
  </aside>

  <section class="timeline">
    <nav>
      <a href="#" class="active">Tweets</a>
      <a href="#">Tweets and replies</a>
      <a href="#">Medias</a>
    </nav>

    <div id="bot-container"></div>
    <div id="post-container"></div>
    <script type="text/babel">
      class Bot extends React.Component {
        constructor(props) {
          super(props);
          this.intervalId = null;
          this.state = {
            count: 10000,
            step: 5000,
            isAdd: true,
            value: "",
            isFetching: false
          };
        }

        handleClick = () => {
          this.setState(({
                           count,
                           step,
                           isAdd
                         }) => {
            if (isAdd) {
              return { count: count + step };
            } else if (count === 0) {
              return { count: 0 };
            } else {
              return { count: count - step };
            }
          });
        };

        editStep = ({ target: { value } }) => this.setState({ step: Number(value) });

        changeMode = () => this.setState(({ isAdd }) => ({ isAdd: !isAdd }));

        setValue = (value) => {
          this.setState({
            value
          });
        };

        generateText = () => {
          const head = Date.now().toString(36);
          const tail = Math.random().toString(36).substring(2);
          return `${head}${tail}`;
        };

        startFetching = () => this.setState({ isFetching: true });

        stopFetching = () => this.setState({ isFetching: false });

        clearFetching = () => {
          clearInterval(this.intervalId);
          this.intervalId = null;
        };

        messageBot = () => {
          fetch("http://localhost:3000/api/posts", {
            method: "POST",
            headers: {
              "Content-Type": "application/json;charset=utf-8"
            },
            body: JSON.stringify({ text: this.generateText() })
          });
        };

        componentDidMount() {
          this.startFetching();
        }

        componentDidUpdate() {
          const { isFetching, count } = this.state;
          this.clearFetching();
          if (isFetching) {
            this.intervalId = setInterval(this.messageBot, count);
          }
        }

        componentWillUnmount() {
          this.stopFetching();
          this.clearFetching();
        }

        render() {
          const { count, step, isAdd, value } = this.state;
          return (
            <>
              <form action="/api/posts" onSubmit={(event) => {
                event.preventDefault();
                fetch("http://localhost:3000/api/posts", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json;charset=utf-8"
                  },
                  body: JSON.stringify({ text: value })
                });

              }} method="post">
                <div className="form-control">
                  <label>
                    <input name="text" value={value} onChange={({ target: { value } }) => this.setValue(value)}
                           type="text"
                           placeholder="What's happening?" />
                  </label>
                </div>
                <button type="submit" className="btn primary">Tweet</button>
              </form>
              <h1>Current step: {step} seconds</h1>
              <input type="number" name="number" value={step} onChange={this.editStep} placeholder="Number" />
              <h1>Generation rate: {count} seconds</h1>
              <button onClick={this.changeMode}>Change Mode</button>
              &nbsp;
              <button onClick={this.handleClick}>{isAdd ? "UPP" : "DOWN"}</button>
            </>
          );
        }
      }

      const container = document.querySelector("#bot-container");
      const root = ReactDOM.createRoot(container);
      root.render(<Bot />);
    </script>
    <script type="text/babel">
      const Post = () => {
        const [tweets, setTweets] = React.useState([]);
        const readChunks = (reader) => {
          return {
            async* [Symbol.asyncIterator]() {
              let readResult = await reader.read();
              while (!readResult.done) {
                yield readResult.value;
                readResult = await reader.read();
              }
            }
          };
        };

        async function* readLines(reader) {
          const textDecoder = new TextDecoder();
          let partOfLine = "";
          for await (const chunk of readChunks(reader)) {
            const chunkText = textDecoder.decode(chunk);
            const chunkLines = chunkText.split("\n");
            if (chunkLines.length === 1) {
              partOfLine += chunkLines[0];
            } else if (chunkLines.length > 1) {
              yield partOfLine + chunkLines[0];
              for (let i = 1; i < chunkLines.length - 1; i++) {
                yield chunkLines[i];
              }
              partOfLine = chunkLines[chunkLines.length - 1];
            }
          }
        }

        async function* parseJsonStream(readableStream) {
          for await (const line of readLines(readableStream.getReader())) {
            const trimmedLine = line.trim().replace(/,$/, "");
            if (trimmedLine !== "[" && trimmedLine !== "]") {
              yield JSON.parse(trimmedLine);
            }
          }
        }

        const downloadData = async () => {
          const response = await fetch("http://localhost:3000/api/posts");
          let jsonData = 0;
          for await (const post of parseJsonStream(response.body)) {
            jsonData++;
            setTweets(post);
          }
        };
        downloadData();

        return (
          <ul className="tweets">
            {
              tweets.map((tweet) => {
                return (
                  <li key={tweet.id}>
                    <img src="./assets/images/avatar.png" alt="Avatar" />
                    <div className="info">
                      <strong>
                        <span>@potato</span>
                      </strong>

                      <p>
                        {tweet.text}
                      </p>
                      <div className="actions">
                        <a href="#">
                          <img
                            src="./assets/images/comments.svg"
                            alt="Comments"
                          />
                          9
                        </a>
                        <a href="#">
                          <img
                            src="./assets/images/retweet.svg"
                            alt="Retweet"
                          />
                          15
                        </a>
                        <a href="#">
                          <img src="./assets/images/like.svg" alt="Like" /> 20
                        </a>
                      </div>
                    </div>
                  </li>
                );
              })}
          </ul>
        );
      };

      const domContainer = document.querySelector("#post-container");
      const root = ReactDOM.createRoot(domContainer);
      root.render(<Post />);
    </script>
  </section>

  <aside class="widgets">
    <div class="widget follow">
      <div class="title">
        <strong>Who to follow</strong>
        <a href="#">Refresh</a>
        <a href="#">View all</a>
      </div>

      <ul>
        <li>
          <div class="profile">
            <img src="./assets/images/avatar.png" alt="Avatar" />
            <div class="info">
              <strong>Spade <span>@spade_be</span></strong>
              <button>Follow</button>
            </div>
          </div>
          <a href="#">X</a>
        </li>
        <li>
          <div class="profile">
            <img src="./assets/images/avatar.png" alt="Avatar" />
            <div class="info">
              <strong>Spade <span>@spade_be</span></strong>
              <button>Follow</button>
            </div>
          </div>
          <a href="#">X</a>
        </li>
        <li>
          <div class="profile">
            <img src="./assets/images/avatar.png" alt="Avatar" />
            <div class="info">
              <strong>Spade <span>@spade_be</span></strong>
              <button>Follow</button>
            </div>
          </div>
          <a href="#">X</a>
        </li>
      </ul>
    </div>
  </aside>
</div>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>